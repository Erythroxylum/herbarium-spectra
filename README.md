# Herbarium-Spectra: Codes for spectral data processing, trait prediction, and taxonomic classification  
Datasets and scripts for the manuscript, "Seeing herbaria in a new light: leaf reflectance spectroscopy unlocks predictive trait and
classification modeling in plant biodiversity collections"

Access it here: https://ecoevorxiv.org/repository/view/8529/

Codes written by J. Antonio Guzmán Q. and Dawson M. White

This project was funded by the Harvard University Herbaria and the NSF BII DBI-2021898, with personnel support from NSF REU-2150058.

Use of this code is restricted to non-commercial, academic purposes.  
Please contact Erythroxylum for other use cases.

---

## Data 

### Download Herbarium data

Raw, 350-2500 nm: https://drive.google.com/file/d/1_bnzdlXsSkzrLFELbbS9wgQpDPQwq4Ef/view?usp=drive_link

Reflectance, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1ZBQGuae5zxliNUAUAXa7P3nfC3J2x6OM/view?usp=drive_link

Normalized, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1WfuBLkThTyftzUcrA3S1_gtvigJEKtkb/view?usp=drive_link

CWT, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1Sb1NlduodcEPBb5WTfVU6r5iddzdPQMn/view?usp=drive_link

### Download Kothari data

Raw, 350-2500 nm: https://drive.google.com/file/d/1GUSemp1XfPWn3pkPg2oKudxhpk5fONzq/view?usp=sharing

Reflectance, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1zYdDELh9k5y-0inQco18rRVHhQzoQdhB/view?usp=sharing

Normalized, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1xrx5iIiRJ3qtmMNo3oswpGjYwPD5Zpj1/view?usp=sharing

CWT, 5 nm, 450-4500 nm : https://drive.google.com/file/d/1j2MdQoKL0t4KjU_D4xRPEPLDwH4T8XTj/view?usp=sharing

### Plot spectra

**`plotting/plotting_functions_spectra.R`** Plot means, quartiles, coefficient of variation of spectra (Fig. S2)
  
---

## Data processing
**`R/Spectrolab_process_data.R`**

Scripts for combining spectra and metadata files, vector normalization, metadata manipulation

**`R/spectra_transform.R`**

Scripts for FWHM band resampling, band trimming, and continuous wavelet transformations.

---

## Trait Estimation  

The main script for trait estimation is:  

**`R/leaf_trait_prediction.R`**

This script takes as input either the **Kothari dataset** or the **herbarium dataset**, sets the metadata accordingly, and runs the auxiliary functions to estimate traits and generate output files for analysis.


#### Data Output  

The script generates the following files:  
- **`pls_*_split.rds`**  Testing and validation sample splits.  
- **`pls_*_segments.rds`**  Dataset iterations selecting random spectra per individual, based on the `accession` metadata column.  
- **`*_opt_comp.csv.txt`**  Optimal number of components calculated using the one-sigma method from the `model_tune.R` function.
- **`*plot.pdf`**  Plots showing ncomp optimization evaluation metrics (PRESS, R^2, RMSEP). 
- **`pls_*_opt_comp_models.csv`**  Cross-validation models from `model_tune`.  
- **`*performance.csv`**  Table containing statistics across accessions (nsamples, R², Bias, RMSE, %RMSE, Intercept, Slope)
- **`*obs-pred.csv`**  Data for plotting observed vs. predicted trait values and sample metadata.
- **`pls_*_coefficients.csv`** Model coefficients across segments.  
- **`pls_*_vip.csv`** Variable importance in projection (VIP) scores across segments.  
Optional:
- **`pls_*_final_models.rds`**  Final models across segments generated by the `model_build.R` function. Not written by default.


## Trait prediction from coefficients

Script to predict LMA from coefficients derived from different band regions or transformed spectra and output performance metrics (for Table 2 & Figs 4, 5).

**`R/prediction_from_coefficients_LMA.R`**

Script to predict values for other traits modeled by Kothari et al. 2023 (for Fig. 5)

**`R/prediction_from_coefficients_other_traits.R`**


## Plotting scripts

- **`plotting/plotting_functions_traits.R`**

Reflectance, coefficients and VIP plots (Fig. 3), Trait observed vs predicted biplots (Fig. 4), violin plots of predicted vs observed trait values (Fig. 5)




---

## Taxonomic classification 

The main scripts for trait estimation is:  

**`R/leaf_classification_plsda.R`**
**`R/leaf_classification_lda.R`**

These scripts take the **herbarium dataset** as input, set the metadata accordingly, and run the auxiliary functions to classify at different taxonomic levels using plsda or lda. This can be redirected to classify at the genus or other taxonomic level, or to subset species for direct comparison with the 10 spp. PLS-DA model in Kothari et al. 2023.

#### Data Output  

The scripts generate the following files: 
- **`classification_split.rds`**  Testing and validation sample splits.  
- **`classification_segments.rds`**  Dataset iterations selecting random spectra per individual, based on the `accession` metadata column.  
- **`ncomp_plsda.txt`**  Printed output of components at max highest accuracy, one-sigma method, and value input for final model.   
- **`opt_comp_models_plsda.csv.csv`**  Cross-validation models from `model_tune`.  
- **`classification_*_models.rds`**  Final models across segments generated by the `auxiliary/model_build.R` function. *Not printed by default*
- **`performance_*.csv`**  Table containing performance statistics across accessions.
- **`coefficients_*.rds`** Model coefficients across segments.  
- **`varImp_*.csv`** Variable importance in projection (VIP) scores across segments.
- **`CM_*.rds`** Data necessary for constructing confusion matrices using `plotting/plotting_functions_classification.R`.


## Plotting scripts
- **`plotting/plotting_functions_classification.R`**

Classification performance (Table 3), Confusion matrices (Fig. 6), and VIP plots (Fig. S3, S4).


## Analyses of herbarium factors on classification model success

- **`R/phylogenetic_distance.R`**
Phylogenetic diversity metrics and nearest taxon distances are calculated and table is output to metadata using the phylogenetic distances script.

- **`R/prediction_classification_analysis-factors_plotting.R`**

Scripts for predicting classes based on PLS-DA models generated with `R/leaf_classification_plsda.R`.
The script then contains various plotting functions for the analyses of herbarium factors on classification probabilities and accuracy (Fig. 7, Fig. 8, Table 3, Table S3, Fig. S5, Figs S7-S9).





